# å•ç»†èƒè½¬å½•ç»„å­¦ä¹ ç¬”è®°-12-RPKMæ¦‚å¿µåŠè®¡ç®—æ–¹æ³•

> åˆ˜å°æ³½å†™äº19.7.9+12-**ç¬¬äºŒå•å…ƒç¬¬åè®²ï¼šRPKMæ¦‚å¿µåŠè®¡ç®—æ–¹æ³•**
> ç¬”è®°ç›®çš„ï¼šæ ¹æ®ç”Ÿä¿¡æŠ€èƒ½æ ‘çš„å•ç»†èƒè½¬å½•ç»„è¯¾ç¨‹æ¢ç´¢smart-seq2æŠ€æœ¯ç›¸å…³çš„åˆ†ææŠ€æœ¯
> è¯¾ç¨‹é“¾æ¥åœ¨ï¼šhttp://jm.grazy.cn/index/mulitcourse/detail.html?cid=53

### RPKMé¡»çŸ¥

> æ ¸å¿ƒå°±åœ¨äºåŸºå› é•¿åº¦çš„è®¡ç®—

å‚è€ƒè¿™ä¸ªç½‘ç«™ï¼Œåšçš„è¿˜æ˜¯å¾ˆæ¸…çˆ½çš„ï¼šhttp://www.metagenomics.wiki/pdf/definition/rpkm-calculation

![](https://upload-images.jianshu.io/upload_images/9376801-b42297243dfab7cf.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

å®ƒçš„å…¬å¼çœ‹ä¸Šå»å¾ˆç®€å•ï¼Œå°±æ˜¯å¯¹åŸºå› é•¿åº¦ï¼ˆä¹Ÿå°±æ˜¯å…¬å¼é‡Œçš„`K`ï¼‰ä»¥åŠæ–‡åº“å¤§å°(ä¹Ÿå°±æ˜¯`M`) è¿›è¡Œæ ‡å‡†åŒ–ï¼Œå…¶ä¸­æ–‡åº“å¤§å°å¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯ä¸€ä¸ªæ ·æœ¬å…¨éƒ¨æµ‹åºreadsä¹‹å’Œã€‚ä½†æ˜¯è¿™é‡Œæœ‰ä¸€ä¸ªä¹‹å‰ä¹Ÿæ²¡æœ‰æ³¨æ„åˆ°çš„é—®é¢˜ï¼Œ**åŸºå› é•¿åº¦æ˜¯ä»€ä¹ˆï¼Ÿæ€ä¹ˆè®¡ç®—å‡ºæ¥çš„ï¼Ÿ**

> **å‡ ä¸ªé—®é¢˜ï¼š**å®ƒæ˜¯ç®€å•çš„ç»ˆæ­¢åæ ‡å‡å»èµ·å§‹åæ ‡å—ï¼Ÿå®ƒæ˜¯å¤–æ˜¾å­é•¿åº¦ä¹‹å’Œå—ï¼Ÿé‚£å¤–æ˜¾å­ä¹‹é—´æœ‰é‡åˆæ€ä¹ˆå¤„ç†ï¼Ÿå®ƒæ˜¯æŸä¸€æ¡è½¬å½•æœ¬çš„é•¿åº¦å—ï¼Ÿè¿˜æ˜¯è¯´åŸºå› é•¿åº¦æ˜¯ä¸€ä¸ªè½¬å½•æœ¬çš„å¹³å‡å€¼ï¼Ÿ

è¿™ä¸ªé—®é¢˜æ˜¯è¦å¥½å¥½æ€»ç»“ä¸€ä¸‹ï¼Œä½†é¦–å…ˆè¿˜æ˜¯è¦**æ˜ç¡®ä¸€äº›åŸºå› ç›¸å…³åè¯ï¼š**

- åŸºå› ä¸è½¬å½•æœ¬ï¼šä¸€ä¸ªåŸºå› å¯ä»¥è½¬å½•æˆå¤šä¸ªè½¬å½•æœ¬
- è½¬å½•æœ¬ä¸å¤–æ˜¾å­ï¼šçœŸæ ¸ç”Ÿç‰©çš„æ¯ä¸ªè½¬å½•æœ¬ä¸€èˆ¬æ˜¯ç”±ä¸€ä¸ªæˆ–å¤šä¸ªå¤–æ˜¾å­ç»„æˆ
- è½¬å½•æœ¬ä¸cDNAï¼šè½¬å½•æœ¬é€†è½¬å½•å¾—åˆ°cDNA
- å¤–æ˜¾å­ä¸ç¼–ç åŒºCDSã€éç¼–ç åŒºUTRï¼šå¯ä»¥ç¿»è¯‘æˆè›‹ç™½çš„å¤–æ˜¾å­åŒºåŸŸæ˜¯CDSåŒºåŸŸï¼Œä¸èƒ½ç¿»è¯‘çš„å¤–æ˜¾å­å¼€å¤´ã€ç»“å°¾æ˜¯UTRåŒºåŸŸ
- CDSä¸å¼€æ”¾é˜…è¯»æ¡†ORFï¼šORFæ˜¯ä»èµ·å§‹å¯†ç å­(ATG, but not always)åˆ°ç»ˆæ­¢å¯†ç å­(TAA, TAG, TGA)çš„DNAåºåˆ—ï¼Œå¦å¤–åˆæœ‰ä¸¤ç§é“¾çš„æ–¹å‘ï¼Œå› æ­¤æ€»å…±æœ‰6ç§é˜…è¯»æ¡†ï¼Œå®ƒä¹Ÿä¼šåŒ…å«å†…å«å­(è¿™å¯¼è‡´äº†çœŸæ ¸ç”Ÿç‰©çš„CDSä¸ORFä¸ä¸€è‡´ï¼›å¦å¤–åœ¨åŸæ ¸ç”Ÿç‰©ä¸­å®ƒä»¬æ˜¯ä¸€æ ·çš„)
  http://www.scfbio-iitd.res.in/tutorial/orf.html

**ä¸­å¿ƒæ³•åˆ™æ–¹å‘ï¼š**"***DNA*** *makes* ***RNA*** *makes **Protein***"

- å¤–æ˜¾å­å’Œå†…å«å­æ˜¯DNAå±‚é¢çš„gene featureï¼Œå¯†ç å­(codon)æ˜¯RNAå±‚é¢ä¸Šçš„featureï¼›å¤–æ˜¾å­å’Œå†…å«å­éƒ½å­˜åœ¨äºåŒé“¾DNAï¼ˆ**dsDNA**ï¼‰çš„è›‹ç™½ç¼–ç åŸºå› åŒºåŸŸä¸­ï¼Œä¸€èˆ¬é€šè¿‡sense strandï¼Œä¹Ÿå³æ˜¯5â€™=ã€‹3â€˜æŸ¥çœ‹

- ç„¶ådsDNAå˜æˆ**hnRNA** (ä¸å‡ä¸€æ ¸RNAï¼šheterogeneous nuclear RNA)ï¼Œå’ŒdsDNAçš„ **5'-3'** æ–¹å‘ä¸€è‡´ï¼Œå¦å¤–å°†Tç¢±åŸºæ¢æˆäº†Uã€‚è¿™é‡Œè™½ç„¶hnRNAä¸­ä¹Ÿå«æœ‰dsDNAçš„exonã€intronåºåˆ—ï¼Œä½†ç§°å‘¼è¦æ¢ï¼š"exon transcripts"å’Œ"intron transcripts"

- æ¥ç€hnRNAè¿›è¡Œäº†excision ('splicing out') æ“ä½œï¼Œåˆ‡æ‰äº†intron transcriptsï¼Œå°†å‰©ä½™çš„exon transcriptsæ‹¼æ¥èµ·æ¥ï¼Œå¾—åˆ°**mRNA**ã€‚mRNAçš„åºåˆ—æ˜¯å’ŒDNAçš„exonåºåˆ—ä¸€è‡´çš„ï¼Œå®ƒä¹Ÿå¯ä»¥è§†ä½œç”±dsDNAçš„sense strandåºåˆ—å°†Tå˜Uã€‚å¯†ç å­åœ¨DNAä¸­å«"condons"ï¼Œåœ¨mRNAä¸­å«"triplets"

  >  In bioinformatics, the **64 triplets** are sometimes presented as a **"*translation table*"** that can be used directly with the Sense Strand sequence to infer the protein sequence. 

https://www.mun.ca/biology/scarr/Exons_Introns_Codons.html

##### å…³äºåŸºå› é•¿åº¦

æ—¢ç„¶åŸºå› åŒ…å«è¿™ä¹ˆå¤š"ç»„ä»¶"ï¼Œé‚£ä¹ˆæ±‚å®ƒçš„é•¿åº¦ä¹Ÿä¼šæœ‰å‡ ç§æ–¹æ³•ï¼š

- é€‰æ‹©**æœ€é•¿çš„è½¬å½•æœ¬**
- å¤šä¸ªè½¬å½•æœ¬çš„**å‡å€¼**
- **éå†—ä½™å¤–æ˜¾å­**é•¿åº¦ä¹‹å’Œ
- **éå†—ä½™CDS**ä¹‹å’Œ

> æ³¨æ„åˆ°è¿™é‡Œçš„**"éå†—ä½™"**ï¼Œå°±æ˜¯å­˜åœ¨ä¸€ä¸ªåŸºå› çš„å¤šä¸ªå¤–æ˜¾å­ä¹‹é—´å­˜åœ¨é‡å ï¼ˆæ¯”å¦‚åŸºå› Açš„1å·å¤–æ˜¾å­è¾ƒçŸ­ï¼Œ2å·å¤–æ˜¾å­é•¿ï¼Œ1å·åŒ…å«åœ¨2å·ä¸­ï¼‰ï¼Œå•çº¯çš„ç›¸åŠ ä¼šé‡å¤è®¡ç®—

### ä¸‰ç§æ–¹æ³•æ¥è®¡ç®—åŸºå› é•¿åº¦

#### ç¬¬ä¸€ç§ï¼šéå†—ä½™å¤–æ˜¾å­ä¹‹å’Œ

##### è½½å…¥åŸå§‹è¡¨è¾¾çŸ©é˜µ

```R
rm(list = ls()) 
options(stringsAsFactors = F)
load(file = '../input.Rdata')
a[1:4,1:4]
head(df)
```

##### é€‰æ‹©å“ªä¸ªåŒ…æ¥è®¡ç®—åŸºå› é•¿åº¦å‘¢ï¼Ÿ

ä¸çŸ¥é“å°±æœç´¢ä¸€ä¸‹ï¼š

![](https://upload-images.jianshu.io/upload_images/9376801-22188f99ab32ec86.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

ç„¶åæ‰¾åˆ°`TxDb`è¿™ä¸ªåŒ…çš„ä»‹ç»ï¼Œçœ‹Bioconductorè¿™æœ¬ç”µå­ä¹¦çš„`41é¡µ 3.4.19èŠ‚`ï¼šhttps://bioconductor.github.io/BiocWorkshops/BioC2018.pdf

å…¶ä¸­å†™é“ï¼š![](https://upload-images.jianshu.io/upload_images/9376801-14257f36195f7221.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

##### èµ·æ­¥

å› ä¸ºå¤„ç†çš„æ˜¯å°é¼ æ•°æ®ï¼Œæ‰€ä»¥è¦åŠ è½½ç›¸åº”å°é¼ çš„åŒ…ï¼š

```R
library("TxDb.Mmusculus.UCSC.mm10.knownGene")
# åŠ è½½åŒ…ä»¥åï¼Œçœ‹çœ‹å¸®åŠ©æ–‡æ¡£ï¼Œå‘ç°è¿™ä¹ˆä¸€å¥è¯(ä½¿ç”¨å®ƒåªéœ€è¦callå®ƒçš„åå­—)
## show the db object that is loaded by calling it's name

txdb <- TxDb.Mmusculus.UCSC.mm10.knownGene
# ä¾ç„¶ä¸çŸ¥é“æ€ä¹ˆç”¨ï¼Œé‚£ä¹ˆå°±å†çœ‹å¸®åŠ©æ–‡æ¡£çš„"see also"ä¿¡æ¯
```

![](https://upload-images.jianshu.io/upload_images/9376801-d59abd54cd3f7b9b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

ç‚¹è¿›å»å‘ç°ï¼Œå­˜åœ¨å¥½å¤šå‡½æ•°ï¼Œå› ä¸ºæˆ‘ä»¬æƒ³é‡‡ç”¨éå†—ä½™å¤–æ˜¾å­åŠ å’Œçš„æ–¹æ³•è®¡ç®—åŸºå› é•¿åº¦ï¼Œå› æ­¤é€‰æ‹©`exon`å’Œ`genes`å°±å¥½äº†

![](https://upload-images.jianshu.io/upload_images/9376801-ba3acee451d15411.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

```R
# å–å‡ºexonå’Œgene
exon_txdb=exons(txdb)
genes_txdb=genes(txdb)
>   genes_txdb
GRanges object with 24368 ranges and 1 metadata column:
            seqnames              ranges strand |     gene_id
               <Rle>           <IRanges>  <Rle> | <character>
  100009600     chr9   21062393-21075496      - |   100009600
  100009609     chr7   84940169-84964009      - |   100009609
# çœ‹åˆ°ç»“æœæ˜¯ä¸€ä¸ªGRanges objectï¼Œé‚£ä¹ˆä¸æ‡‚å°±å†æœç´¢ä»€ä¹ˆæ˜¯GRanges
?GRanges
# The GRanges class is a container for the genomic locations and their associated annotations. å°±æ˜¯å­˜å‚¨åŸºå› ç»„åæ ‡å’Œç›¸å…³æ³¨é‡Šä¿¡æ¯çš„"å®¹å™¨"
```

å› ä¸ºå–å‡ºçš„exonå’Œgeneéƒ½æ˜¯åæ ‡ä¿¡æ¯(å¯ä»¥çœ‹åˆ°ä¸Šé¢çš„`21062393-21075496`å°±æ˜¯åæ ‡åŒºé—´)ï¼Œé‚£ä¹ˆäºŒè€…æ—¢ç„¶éƒ½æ˜¯åæ ‡è€Œä¸”ä¸ä¸€è‡´ï¼Œå°±ä¼šæœ‰äº¤å‰ï¼Œå¦‚ä½•æ‰¾åˆ°è¿™ä¸ªäº¤å‰ï¼Ÿ

> åˆå¼•å…¥äº†ä¸€ä¸ªæ–°çš„å‡½æ•°=ã€‹findOverlaps

```R
o = findOverlaps(exon_txdb,genes_txdb)
>   o
Hits object with 252602 hits and 0 metadata columns:
           queryHits subjectHits
           <integer>   <integer>
       [1]         1        6729
       [2]         2        6729
       [3]         3        6729
       [4]         4        6729
       [5]         5        6729
       ...       ...         ...
# å…¶ä¸­exon_txdbå› ä¸ºå†™åœ¨å‰é¢ï¼Œäºæ˜¯å®ƒå°±ä½œä¸ºqueryHitsï¼›å¯ä»¥çœ‹åˆ°ï¼šå®ƒçš„ç¬¬ä¸€ä¸ªå…ƒç´ å’Œgenes_txdbçš„6729å­˜åœ¨äº¤å‰ï¼Œå–å‡ºæ¥çœ‹ä¸€ä¸‹ç»“æœ
> genes_txdb[6729]
GRanges object with 1 range and 1 metadata column:
        seqnames          ranges strand |     gene_id
           <Rle>       <IRanges>  <Rle> | <character>
  18777     chr1 4807893-4846735      + |       18777
> exon_txdb[1]
GRanges object with 1 range and 1 metadata column:
      seqnames          ranges strand |   exon_id
         <Rle>       <IRanges>  <Rle> | <integer>
  [1]     chr1 4807893-4807982      + |         1
# exonçš„ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯chr1 4807893-4807982ï¼Œå¯¹åº”ä¸Šäº†åŸºå› çš„ç¬¬6729ä¸ªå…ƒç´ ï¼šchr1 4807893-4846735ï¼Œäºæ˜¯è¿™ä¸ªexonå°±å±äºè¿™ä¸ªåŸºå› 
```

æ—¢ç„¶å¾—åˆ°äº†æ‰€æœ‰çš„overlapï¼Œé‚£å°±åˆ†åˆ«æå–å‡ºæ¥exonå’Œgeneçš„ä¿¡æ¯

```R
t1=exon_txdb[queryHits(o)]
t2=genes_txdb[subjectHits(o)]

t1=as.data.frame(t1) #æ›´ç›´è§‚åœ°æ¥æŸ¥çœ‹t1ï¼Œç»“æœå°†25wä¸ªå¤–æ˜¾å­çš„åæ ‡
```

![](https://upload-images.jianshu.io/upload_images/9376801-98a89365a0c7c130.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

ä¸ºäº†ç»™t1ä¸€ä¸ªå¯¹åº”çš„åŸºå› IDï¼Œéœ€è¦ä½¿ç”¨t2

```R
t1$geneid=mcols(t2)[,1]
# mcolsä½œç”¨æ˜¯æå– a DataFrame object containing the metadata columns
# çœ‹ä¸‹é¢ğŸ‘‡è¿™ä¸ªï¼Œmcols(t2)[,1]æå–çš„ä¹Ÿå°±æ˜¯è™šçº¿å³ä¾§çš„ä¸€åˆ—"gene_id"
> genes_txdb[6729]
GRanges object with 1 range and 1 metadata column:
        seqnames          ranges strand |     gene_id
           <Rle>       <IRanges>  <Rle> | <character>
  18777     chr1 4807893-4846735      + |       18777
```

å†çœ‹ä¸€çœ¼ç»“æœï¼š

![](https://upload-images.jianshu.io/upload_images/9376801-72d53106d9ba06f3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

##### å…³é”®ä¸€æ­¥

å¥½ï¼Œçœ‹åˆ°åŸºå› 18777å¯¹åº”ç€10ä¸ªexonï¼Œé‚£ä¹ˆå¦‚ä½•æ±‚è¿™ä¸ª18777çš„é•¿åº¦å‘¢ï¼Ÿæ˜¯ç®€å•æŠŠ10ä¸ªexonçš„ç¬¬å››åˆ—åŠ èµ·æ¥å—ï¼Ÿ

> ä¸æ˜¯çš„ï¼è¯·çœ‹ï¼šç¬¬8å’Œç¬¬9ä¸ªexonï¼Œå®ƒä»¬æ˜¯ä¸æ˜¯æœ‰é‡å ï¼Ÿæˆ–è€…è¯´exon9æ˜¯åŒ…å«exon8çš„ã€‚é‚£ä¹ˆåº”è¯¥ç”¨`sum-overlap`çš„æ–¹æ³•ï¼Œsumå¥½æ±‚ï¼Œä½†overlapå‘¢ï¼Ÿ
>
> å¯ä»¥è¿™æ ·ï¼šå…ˆä¸è€ƒè™‘å…·ä½“é•¿åº¦å€¼ï¼Œä¾‹å¦‚ç°åœ¨ä¸ç›´æ¥è®©exon1çš„é•¿åº¦ä¸º90ï¼Œè€Œæ˜¯è¾“å‡º4807893 - 4807982è¿™90ä¸ªæ•°å€¼ï¼Œç›®çš„å°±æ˜¯ä½¿ç”¨`unique()`å‡½æ•°å¯¹è¿™äº›æ•°å€¼å»é‡å¤ï¼Œæœ€åä¸€ä¸ª`length`å°±æ±‚å‡ºæ¥äº†

è¿™ä¸ªæ€è·¯æœ‰äº†ï¼Œè€Œä¸”è¿™ä¸ªè¿‡ç¨‹ä¸€å®šæ˜¯ä¸ªå¾ªç¯ï¼Œé‚£ä¹ˆç¬¬ä¸€æ­¥å°±æ˜¯ï¼šå°†å¯¹åº”åˆ°åŒä¸€ä¸ªåŸºå› IDçš„å¤–æ˜¾å­éƒ½æ”¾ä¸€èµ·

```R
# åˆ©ç”¨split(x,f)ï¼Œéœ€è¦ä¸€ä¸ªxï¼Œä¸€ä¸ªfå‚æ•°ï¼Œå…¶ä¸­xæ˜¯å‘é‡æˆ–æ•°æ®æ¡†ï¼Œfæ˜¯åˆ†ç»„çš„å› å­ã€‚æ‹†åˆ†å®Œè¿”å›åˆ—è¡¨
split(t1,as.factor(t1$geneid))
```

ç„¶åç¬¬äºŒæ­¥æ˜¯å¯¹åˆ—è¡¨çš„æ¯ä¸ªå…ƒç´ å–`start`åˆ°`end`çš„å…¨éƒ¨æ•°å€¼ï¼Œä¹Ÿå°±æ˜¯ç¬¬äºŒåˆ—åˆ°ç¬¬ä¸‰åˆ—ï¼Œå®ƒè¿”å›çš„æ˜¯ä¸€ä¸ªåˆ—è¡¨

```R
apply(x,1,function(y){y[2]:y[3]})
```

æœ€åä¸€æ­¥å°±æ˜¯å¯¹åˆ—è¡¨å»é‡ã€æ±‚é•¿åº¦ã€‚

> å»é‡æœ‰ä¸¤ç§æ–¹æ³•ï¼š
> ä¸€æ˜¯æ±‚æ€»é•¿åº¦ï¼Œç„¶åå»overlapï¼›äºŒæ˜¯å…ˆå»overlapï¼Œå†æ±‚æ€»é•¿åº¦
> è¿™é‡Œé‡‡ç”¨è¿‚å›å¼çš„ç¬¬äºŒç§ï¼Œä¹Ÿæ›´å®¹æ˜“æ“ä½œ
> å°±æ˜¯æ£€æµ‹` y[2]:y[3]`ï¼Œå‘ç°æœ‰é‡å¤çš„æ•°å­—è®¡ç®—ä¸€éå³å¯ï¼Œå› ä¸ºè¿™ä¸€ä¸ªæ•°å­—å°±ä»£è¡¨ä¸€ä¸ªç¢±åŸºä½ç‚¹

```R
length(unique(unlist(tmp)))
```

ç»¼ä¸Šï¼Œå¾—åˆ°ä¸€ä¸ªå¾ªç¯åµŒå¥—ï¼š

```R
g_l = lapply(split(t1,t1$geneid),function(x){
    tmp=apply(x,1,function(y){
      y[2]:y[3]
    })
    length(unique(unlist(tmp)))
  })
# å†å˜æˆä¸€ä¸ªæ•°æ®æ¡†
g_l=data.frame(gene_id=names(g_l),length=as.numeric(g_l))
> head(g_l)
    gene_id length
1 100009600   4352
2 100009609   2538
3 100009614    564
4 100009664   2398
5    100012   1854
6    100017   2736
# ç»“æœå°†gene_idå¯¹åº”åˆ°symbol
library(org.Mm.eg.db)
s2g=toTable(org.Mm.egSYMBOL)
g_l=merge(g_l,s2g,by='gene_id')
```

![](https://upload-images.jianshu.io/upload_images/9376801-42ffe253299531d7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

---

#### ç¬¬äºŒç§ï¼šæ ¹æ®æœ€é•¿è½¬å½•æœ¬

è¿™ä¸ªå°±ç¨å¾®æ–¹ä¾¿ä¸€ç‚¹ï¼Œæœ‰ä¸€ä¸ªæ±‚è½¬å½•æœ¬é•¿åº¦çš„å‡½æ•°ï¼š`transcriptLengths`

```R
t_l=transcriptLengths(txdb)
>   head(t_l)
  tx_id    tx_name gene_id nexon tx_len
1     1 uc007afg.1   18777     8   2355
2     2 uc007afh.1   18777     9   2433
3     3 uc007afi.2   21399    10   2671
4     4 uc011wht.1   21399    10   2668
5     5 uc011whu.1   21399    10   2564
6     6 uc057aty.1    <NA>     1   2719
# å‘ç°æœ‰NAï¼Œå»æ‰å³å¯
t_l=na.omit(t_l)
>   head(t_l)
  tx_id    tx_name gene_id nexon tx_len
1     1 uc007afg.1   18777     8   2355
2     2 uc007afh.1   18777     9   2433
3     3 uc007afi.2   21399    10   2671
4     4 uc011wht.1   21399    10   2668
5     5 uc011whu.1   21399    10   2564
7     7 uc007afm.2  108664     6   2396
```

ç„¶åçœ‹åˆ°`gene_id`è¿™ä¸€åˆ—ï¼Œæœ‰é‡å¤çš„IDï¼Œå¦å¤–æœ€åä¸€åˆ—çš„lengthå€¼ä¹Ÿä¸åŒï¼Œè¯´æ˜è¿™é‡Œ**ä¸€ä¸ªåŸºå› æœ‰å¤šä¸ªä¸åŒé•¿åº¦çš„è½¬å½•æœ¬**

é‚£ä¹ˆå°±å¯¹`gene_id`æ’åº(ä¸ºäº†è®©åŒæ ·idçš„åŸºå› æ’åœ¨ä¸€èµ·)ï¼Œå¯¹`tx_len`æ’åº(ä¸ºäº†æ‰¾æœ€é•¿çš„è½¬å½•æœ¬)

```R
t_l=t_l[order(t_l$gene_id,t_l$tx_len,decreasing = T),]
> head(t_l)
      tx_id    tx_name gene_id nexon tx_len
15232 15232 uc008vih.2   99982    20   3075
15231 15231 uc008vig.2   99982    19   3015
9376   9376 uc008pkr.1   99929     6   4154
11784 11784 uc008rsk.3   99899     8   2909
11479 11479 uc008rat.3   99890     2   3065
11480 11480 uc008rau.2   99890     1   2475
# ä¸Šé¢ğŸ‘†å¯ä»¥çœ‹åˆ°ï¼Œ99982è¿™ä¸ªåŸºå› å°±ä¼šé€‰å–ç¬¬ä¸€ä¸ªè½¬å½•æœ¬15232ï¼Œå› ä¸ºå®ƒçš„é•¿åº¦ä¸º3075
# å…¶å®è¿™æ ·é™åºæ’åˆ—å®Œï¼Œå°±å¯ä»¥ç›´æ¥å»é‡ï¼Œä¿ç•™æœ€é•¿çš„é‚£ä¸€ä¸ª(å°±æ˜¯ç¬¬ä¸€ä¸ª)äº†
t_l=t_l[!duplicated(t_l$gene_id),]
>   head(t_l)
      tx_id    tx_name gene_id nexon tx_len
15232 15232 uc008vih.2   99982    20   3075
9376   9376 uc008pkr.1   99929     6   4154
11784 11784 uc008rsk.3   99899     8   2909
11479 11479 uc008rat.3   99890     2   3065
10866 10866 uc008pqg.3   99889    10   3248
11552 11552 uc008rdv.2   99887     8   6271
```

---

### æœ‰äº†åŸºå› é•¿åº¦ï¼Œè®¡ç®—RPKM

ä¸Šé¢å¾—åˆ°äº†æœ‰é•¿åº¦ä¿¡æ¯çš„åŸºå› ï¼Œ**é¦–å…ˆè¦å’ŒåŸå§‹çŸ©é˜µçš„è¡Œåå–äº¤é›†**

```R
ng=intersect(rownames(a),g_l$symbol)
# å¾—åˆ°çš„æ–°è¡¨è¾¾çŸ©é˜µ=ã€‹æœ‰é•¿åº¦ä¿¡æ¯çš„åŸºå› è¡¨è¾¾çŸ©é˜µ
exprSet=a[ng,]
lengths=g_l[match(ng,g_l$symbol),2] #
> head(lengths)
[1] 1122  795  619 4556 1743 1471
> head(rownames(exprSet))
[1] "0610005C13Rik" "0610009B22Rik" "0610009L18Rik" "0610010F05Rik"
[5] "0610010K14Rik" "0610012G03Rik"

# ç®€å•æ¢ç´¢
> exprSet[1:3,1:3]
              SS2_15_0048_A3 SS2_15_0048_A6 SS2_15_0048_A5
0610005C13Rik              0              0              0
0610009B22Rik              0              0              0
0610009L18Rik              0              0              0
> dim(exprSet)
[1] 22731   768
```

æ¥ä¸‹æ¥å°±æ˜¯å¯¹æ–°è¡¨è¾¾çŸ©é˜µè¿›è¡Œæ“ä½œï¼š

**å…ˆæ±‚æ–‡åº“å¤§å°**ï¼š

```R
total_count<- colSums(exprSet)
> head(total_count)
SS2_15_0048_A3 SS2_15_0048_A6 SS2_15_0048_A5 SS2_15_0048_A4 
         95099          92537         161260         121297 
SS2_15_0048_A1 SS2_15_0048_A2 
        263927         280547 
```

ç„¶åéœ€è¦å¯¹æ¯ä¸ªåŸºå› è¡¨è¾¾é‡å€¼é™¤ä»¥å¯¹åº”çš„åŸºå› é•¿åº¦ï¼ˆå•ä½æ˜¯Kbï¼‰ï¼Œå†é™¤ä»¥æ€»æ–‡åº“ï¼ˆå•ä½æ˜¯Mbï¼‰å¤§å°

```R
# å¦‚æœè¯´iä»£è¡¨ä¸€è¡Œè¡¨è¾¾é‡ï¼ŒexprSet[,i]å°±æ˜¯è¡¨è¾¾çŸ©é˜µçš„ç¬¬ä¸€åˆ—ï¼Œå³22731ä¸ªåŸºå› çš„è¡¨è¾¾é‡ï¼Œlengthså°±æ˜¯22731ä¸ªåŸºå› çš„é•¿åº¦ï¼Œå®ƒå’ŒexprSet[,i]æ˜¯ä¸€ä¸€å¯¹åº”çš„ã€‚total_count[i]å°±æ˜¯ç¬¬ä¸€ä¸ªæ ·æœ¬çš„æ–‡åº“å¤§å°ã€‚æœ€åéœ€è¦ä¹˜ä»¥10^9æ¥æŠµæ¶ˆå•ä½çš„å½±å“
10^9*exprSet[,i]/lengths/total_count[i]
```

**å†åšä¸€ä¸ªå¾ªç¯ï¼š**

å®ç°äº†ä»ç¬¬ä¸€ä¸ªæ ·æœ¬åˆ°æœ€åä¸€ä¸ªæ±‚å¾—RPKMï¼Œç»“æœè¿”å›ä¸€ä¸ªåŒ…å«768ä¸ªå…ƒç´ çš„åˆ—è¡¨ï¼Œæ¯ä¸ªæ ·æœ¬æ±‚å¾—çš„RPKMå€¼å ä¸€è¡Œ

```R
lapply(1:length(total_count),
                          function(i){
  10^9*exprSet[,i]/lengths/total_count[i]
})
```

æ¥ç€å¯¹æ¯ä¸ªå…ƒç´ è¿›è¡Œrbindæ“ä½œï¼Œæ‹¼æ¥åˆ°ä¸€èµ·ï¼Œä½†æ˜¯æ‹¼æ¥çš„ç»“æœæ˜¯ï¼š768è¡Œï¼Œ22731åˆ—

```R
do.call(rbind,
        lapply(1:length(total_count),
        function(i){
  10^9*exprSet[,i]/lengths/total_count[i]
}))
```

æœ€åè¦è½¬ç½®ä¸€ä¸‹ï¼š

```R
rpkm <- t(do.call( rbind,
                   lapply(1:length(total_count),
                          function(i){
  10^9*exprSet[,i]/lengths/total_count[i]
}) ))
# æ£€æŸ¥ä¸‹
> rpkm[1:4,1:4]
     [,1] [,2] [,3]      [,4]
[1,]    0    0    0  7.347796
[2,]    0    0    0  0.000000
[3,]    0    0    0  0.000000
[4,]    0    0    0 19.904850
```

##### å›é¡¾æ€»ç»“

> ä¸‹é¢å°±ä»¥åˆšåˆšè®¡ç®—å‡ºæ¥çš„ç¬¬ä¸€è¡Œï¼Œç¬¬å››åˆ—çš„`7.347796`è¿™ä¸ªå€¼ä¸ºä¾‹ï¼Œçœ‹çœ‹åˆ°åº•RPKMæ˜¯æ€ä¹ˆç®—å‡ºæ¥çš„ï¼Œç®—æ˜¯ä¸€ä¸ªå¤ä¹ 

é¦–å…ˆçœ‹ä¸‹è¡¨è¾¾çŸ©é˜µï¼š

```R
> exprSet[1:4,1:4]
              SS2_15_0048_A3 SS2_15_0048_A6 SS2_15_0048_A5
0610005C13Rik              0              0              0
0610009B22Rik              0              0              0
0610009L18Rik              0              0              0
0610010F05Rik              0              0              0
              SS2_15_0048_A4
0610005C13Rik              1
0610009B22Rik              0
0610009L18Rik              0
0610010F05Rik             11

# ç¬¬ä¸€è¡Œç¬¬å››åˆ—ï¼Œä¹Ÿå°±æ˜¯0610005C13RikåŸºå› åœ¨SS2_15_0048_A4æ ·æœ¬ä¸­çš„åŸå§‹è¡¨è¾¾é‡ä¸º1
# ç„¶åæ€»çš„æ–‡åº“å¤§å°æ˜¯121297
> total_count[4]
SS2_15_0048_A4 
        121297 
# å®ƒçš„ç¬¬ä¸€ä¸ªåŸºå› 0610005C13Riké•¿åº¦æ˜¯1122
> lengths[1]
[1] 1122
# å› æ­¤è®¡ç®—å…¬å¼å°±æ˜¯
# 10^9*exprSet[,i]/lengths/total_count[i]
> 10^9*1/1122/121297
[1] 7.347796
```

ä»è¿™ä¸ªè®¡ç®—ç»“æœä¹Ÿå¯ä»¥çœ‹åˆ°ï¼šRPKMå€¼ä¸º7ï¼Œå®ƒçš„countå€¼æ‰ä¸º1ï¼Œè¿™æ ·ä¼šè¿‡æ»¤æ‰å¾ˆå¤šå­˜åœ¨RPKMè¡¨è¾¾é‡çš„åŸºå› ï¼Œå› æ­¤è¿‡æ»¤åŸºå› è®¾å®šcountå€¼ä¸º0å°±å¥½

> æ³¨æ„ï¼šä¸è¦è®¤ä¸ºcountå€¼ä¸º1äº†ï¼ŒRPKMå°±æ˜¯7å·¦å³ã€‚è¿™ä¸ªè¦å–å†³äºæ–‡åº“å¤§å°ï¼Œå¦‚æœæ–‡åº“å¾ˆå°ï¼Œé‚£ä¹ˆcountä¸º1æ—¶ï¼ŒRPKMä¹Ÿèƒ½è¾¾åˆ°å‡ ä¸‡

æœ€åå’Œæ–‡ç« æä¾›çš„RPKMçŸ©é˜µæ¯”è¾ƒä¸‹ï¼š

```R
a=read.table('../GSE111229_Mammary_Tumor_fibroblasts_768samples_rpkmNormalized.txt.gz',
             header = T ,sep = '\t')
a[1:4,1:4]
rpkm_paper=a[ng,] 
# æ–‡ç« åšçš„
> rpkm_paper[1:4,1:4]
              SS2_15_0048_A3 SS2_15_0048_A6 SS2_15_0048_A5
0610005C13Rik              0              0              0
0610009B22Rik              0              0              0
0610009L18Rik              0              0              0
0610010F05Rik              0              0              0
              SS2_15_0048_A4
0610005C13Rik       6.966712
0610009B22Rik       0.000000
0610009L18Rik       0.000000
0610010F05Rik      19.843349
# æˆ‘ä»¬åšçš„
> rpkm[1:4,1:4]
     [,1] [,2] [,3]      [,4]
[1,]    0    0    0  7.347796
[2,]    0    0    0  0.000000
[3,]    0    0    0  0.000000
[4,]    0    0    0 19.904850
```

å¯ä»¥çœ‹åˆ°æœ‰ä¸€ç‚¹å·®åˆ«ï¼Œä½†å·®åˆ«ä¸å¤§ï¼Œè¿™æ˜¯å› ä¸ºè®¡ç®—çš„åŸºå› é•¿åº¦æ–¹æ³•æ˜¯æœ‰å·®åˆ«çš„





