# å•ç»†èƒè½¬å½•ç»„å­¦ä¹ ç¬”è®°-6

> åˆ˜å°æ³½å†™äº19.6.18
> ç¬”è®°ç›®çš„ï¼šæ ¹æ®ç”Ÿä¿¡æŠ€èƒ½æ ‘çš„å•ç»†èƒè½¬å½•ç»„è¯¾ç¨‹æ¢ç´¢smart-seq2æŠ€æœ¯ç›¸å…³çš„åˆ†ææŠ€æœ¯
> è¯¾ç¨‹é“¾æ¥åœ¨ï¼šhttp://jm.grazy.cn/index/mulitcourse/detail.html?cid=53
> ç¬¬äºŒå•å…ƒç¬¬å››è®²ï¼šå¾—åˆ°è¡¨è¾¾çŸ©é˜µåçœ‹å†…éƒ¨å¼‚è´¨æ€§

### å‰è¨€

ä¾ç„¶æ˜¯ä¸»è¦ä»£ç è·Ÿç€æµç¨‹èµ°ï¼Œè¿™é‡Œåªå†™ä¸€å†™æˆ‘è®¤ä¸ºæ¯”è¾ƒé‡è¦çš„å†…å®¹

ä¸Šæ¬¡æˆ‘ä»¬å¾—åˆ°äº†åŸå§‹è¡¨è¾¾çŸ©é˜µ`a`ï¼Œè¿‡æ»¤åçš„è¡¨è¾¾çŸ©é˜µ`dat` ï¼Œæ ·æœ¬ä¿¡æ¯`meata`

ç®€å•çœ‹ä¸‹ï¼š

```R
> dim(a)
[1] 24582   768
> dim(dat)
[1] 12198   768
> head(meta)
               g plate  n_g all
SS2_15_0048_A3 1  0048 2624 all
SS2_15_0048_A6 1  0048 2664 all
SS2_15_0048_A5 2  0048 3319 all
SS2_15_0048_A4 3  0048 4447 all
SS2_15_0048_A1 2  0048 4725 all
SS2_15_0048_A2 3  0048 5263 all
# æ ·æœ¬ä¿¡æ¯ä¸­çš„gè¡¨ç¤ºcutreeåˆ†çš„4å¤§èšç±»ç»“æœï¼›plateä¸ºç»†èƒæ¿æ‰¹æ¬¡ï¼›n_gæ˜¯æ¯ä¸ªç»†èƒæ ·æœ¬ä¸­æœ‰è¡¨è¾¾çš„åŸºå› æ•°é‡ï¼›allæš‚æ—¶ç”¨ä¸åˆ°
```

å¦å¤–ï¼Œæ³¨æ„æœ€å¥½æ¯æ¬¡è¿è¡Œä»£ç ä¹‹å‰ï¼Œéƒ½è¦æ¸…ç©ºä¸€ä¸‹å˜é‡ï¼Œç„¶åè®¾ç½®ä¸è¦å°†å­—ç¬¦å‹å˜æˆå› å­å‹å‘é‡

```R
rm(list = ls())  
options(stringsAsFactors = F)
```

### æƒ³è¦åšä¸ªçƒ­å›¾

#### å…ˆæ„å»ºåˆ†ç»„ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯æå–å‡ºå±‚æ¬¡èšç±»ä¿¡æ¯

éœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œcountçš„è¡¨è¾¾çŸ©é˜µå’Œrpkmè¡¨è¾¾çŸ©é˜µçš„èšç±»åˆ†ç»„ç»“æœæ˜¯ä¸ä¸€æ ·çš„

```R
# æˆ‘ä»¬è¿™é‡Œæ˜¯countè¡¨è¾¾çŸ©é˜µåˆ†ç»„
> grp=meta$g
> table(grp)
grp
  1   2   3   4 
312 300 121  35 
```

#### ç„¶åæƒ³æƒ³ï¼Œçƒ­å›¾éœ€è¦ä»€ä¹ˆä¿¡æ¯ï¼Ÿ

**ä¸»è¦å°±æ˜¯è¡Œã€åˆ—**ï¼Œè¡Œæ˜¯åŸºå› ï¼Œåˆ—æ˜¯æ ·æœ¬ã€‚é‚£ä¹ˆ**å…ˆå¯¹åŸºå› ï¼ˆè¡Œï¼‰è¿›è¡Œè®¾ç½®ï¼š**

å› ä¸º`dat`çŸ©é˜µç›¸å¯¹äº`a`è™½ç„¶è¿‡æ»¤æ‰äº†ä¸€ä¸‡å¤šåŸºå› ï¼Œä½†æ˜¯ä¾ç„¶è¿˜å‰©ä¸€ä¸‡å¤šï¼Œç„¶åæˆ‘ä»¬æœ‰700å¤šæ ·æœ¬ï¼Œé‚£ä¹ˆå¯ä»¥ç®—ä¸€ä¸‹ï¼Œè¿™æ ·çš„ç»“æœæ˜¯`10000*700`çš„å›¾ï¼Œç›¸å½“å¤§ï¼Œå¹¶ä¸”çœ‹ä¸å‡ºä»€ä¹ˆå«ä¹‰ã€‚æˆ‘ä»¬**å¯ä»¥å°†åŸºå› æ•°è®¾ç½®å°ä¸€ç‚¹**ï¼Œå¯ä»¥è®¾ç½®æˆ1000ï¼Œå…ˆçœ‹ä¸€ä¸‹

å¥½äº†ï¼ŒåŸºå› æ•°æœ‰äº†ï¼ˆ1000ä¸ªï¼‰ï¼Œ**ä½†æ˜¯å–å“ª1000ä¸ªåŸºå› å‘¢ï¼Ÿ**å¾ˆæ˜¾ç„¶ï¼Œåˆ©ç”¨`head`æˆ–`tail`ç›´æ¥å–å‰/å1000ä¸ªåŸºå› æ˜¯ä¸èƒ½ä½¿äººä¿¡æœçš„ï¼Œè¿™é‡Œå¯ä»¥ç”¨`sd` è¿›è¡Œç­›é€‰ï¼Œä¹Ÿå°±æ˜¯å–è¡¨è¾¾é‡æ ‡å‡†å·®æœ€å¤§çš„1000ä¸ªåŸºå› (ä¹Ÿå³æ˜¯è¯´ï¼Œè¿™1000ä¸ªåŸºå› åœ¨æ‰€æœ‰çš„æ ·æœ¬ä¸­è¡¨è¾¾å·®å¼‚æœ€å¤§ï¼Œè¿™æ ·æ›´åƒå·®å¼‚è¡¨è¾¾åŸºå› )

```R
tail(sort(apply(dat,1,sd)),1000)
# è§£é‡Šä¸‹ä»£ç ï¼šä»é‡Œå‘å¤–çœ‹=ã€‹applyå¯¹datçŸ©é˜µçš„æ¯ä¸€è¡Œæ±‚sdå€¼ï¼Œç„¶åç”¨sortæ’åºï¼Œé»˜è®¤ä»å°åˆ°å¤§ï¼Œç„¶åç”¨tailä»ååˆ°å‰ï¼Œä¹Ÿå³æ˜¯ä»å¤§åˆ°å°å–1000ä¸ª
# æœ€åå–å‡ºåŸºå› å
top_g=names(tail(sort(apply(dat,1,sd)),100))
> head(top_g)
[1] "Comt"    "Mrgprf"  "Stard13" "Cdipt"   "Ifnar1"  "Pdcd6ip"
```

#### ç”»ç¬¬ä¸€å¼ çƒ­å›¾

1000åŸºå›  X 768ä¸ªç»†èƒ = 70å¤šä¸‡çš„ç‚¹

è¿™ä¸ªçƒ­å›¾åæ˜ äº†`log2(cpm+1)`çš„è¡¨è¾¾é‡ï¼ŒèŒƒå›´æ˜¯0-15

```R
library(pheatmap)
pheatmap(dat[top_g,],show_colnames =F,show_rownames = F,
           filename = 'all_cells_top_1000_sd.png')
```

![](https://upload-images.jianshu.io/upload_images/9376801-bda7d40a272df2f9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

#### çƒ­å›¾åŸºç¡€ä¸Šå¢åŠ å½’ä¸€åŒ–

ä¸Šé¢ğŸ‘†é‚£ä¸ªå›¾ï¼Œå¯ä»¥çœ‹å‡ºåŸºå› **ç»å¯¹è¡¨è¾¾é‡** ï¼Œé¢œè‰²è¶Šåçº¢è‰²è¡¨ç¤ºç»å¯¹è¡¨è¾¾é‡è¶Šé«˜ï¼Œæ¯”å¦‚é¡¶éƒ¨é‚£äº›åŸºå› çš„è¡¨è¾¾é‡å°±æ˜¯è¦æ¯”åº•éƒ¨é‚£äº›åŸºå› çš„é«˜

**ä½†æ˜¯ï¼Œæœ‰ä¸ªé—®é¢˜**ï¼Œè¿™æ ·ä¼šå—åˆ°æŸäº›ç‰¹é«˜è¡¨è¾¾åŸºå› çš„å½±å“ï¼Œå¯¼è‡´å…¶ä»–åŸºå› çš„å·®å¼‚å°±ä¸æ˜æ˜¾ï¼›å¦å¤–ï¼Œæˆ‘ä»¬çœŸæ­£å…³å¿ƒçš„æ˜¯ä¸€ä¸ªåŸºå› åœ¨ä¸åŒæ ·æœ¬ä¸­çš„å·®å¼‚ï¼Œæ˜¯ä¸€ç§ç›¸å¯¹çš„è¡¨è¾¾é‡ã€‚

> å¯ä»¥è¿™ä¹ˆç†è§£ï¼šæœ‰çš„åŸºå› æœ¬èº«å°±æ˜¯è¡¨è¾¾é‡å°ï¼Œä½†ä¸èƒ½å› ä¸ºå°å°±è®¤ä¸ºå®ƒåœ¨æ¯ä¸ªæ ·æœ¬éƒ½æ˜¯ä¸€æ ·çš„ã€‚è™½ç„¶å°ï¼Œä¹Ÿæ˜¯æœ‰å·®å¼‚çš„å°ã€‚ä½†å¾€å¾€è¿™ç§å·®å¼‚ä¼šç”±äº"å¼ºè€…"çš„å­˜åœ¨è€Œè¢«å¿½è§†ã€‚
> å› æ­¤ï¼Œè¿™é‡Œæˆ‘ä»¬è¦åšçš„ï¼Œå°±æ˜¯å°†è¿™ç§"å¼±å°"çš„å·®å¼‚ç»™æ‹å‡ºæ¥

ä¸»è¦åˆ©ç”¨`scale()` ï¼Œå…ˆç†è§£ä¸€ä¸‹ï¼š

```R
# æ„å»ºä¸€ä¸ªæµ‹è¯•æ•°æ®
x=1:10;plot(x)
scale(x);plot(scale(x))# ç»“æœå°±æ˜¯å˜æˆä»-1.4åˆ°+1.4çš„èŒƒå›´
```

![](https://upload-images.jianshu.io/upload_images/9376801-934f8c404f613c8c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

å¯ä»¥çœ‹åˆ°ï¼Œscaleåå¹¶ä¸æ”¹å˜æ•°æ®åˆ†å¸ƒï¼Œåªæ˜¯ä¿®æ”¹äº†åæ ‡ï¼Œè®©ç»“æœå–å€¼æ›´åŠ é›†ä¸­

æ³¨æ„ï¼š**scaleæ˜¯å¯¹åˆ—è¿›è¡Œæ“ä½œ**ï¼Œè€Œæˆ‘ä»¬æ˜¯æƒ³å¯¹åŸºå› (ä¹Ÿå°±æ˜¯æŒ‰è¡Œæ“ä½œ)ï¼Œè¿™ä¸ªå‡½æ•°æœ‰ä¸¤ä¸ªä¸»è¦çš„é€‰é¡¹ï¼š`center`å’Œ`scale` ï¼Œå…¶ä¸­`center`æ˜¯å°†æ¯åˆ—çš„å…ƒç´ å‡å»è¿™ä¸€åˆ—çš„å‡å€¼(è¿™ä¸ªé€‰é¡¹æ˜¯é»˜è®¤TRUEçš„)ï¼›`scale` æ˜¯åœ¨centeræ“ä½œåï¼Œå†å°†å¤„ç†è¿‡çš„å…ƒç´ é™¤ä»¥æ ‡å‡†å·®(åŒæ ·æ˜¯é»˜è®¤TRUEçš„)ã€‚å¦å¤–ï¼Œå¤„ç†å®Œåˆ«å¿˜äº†å†è½¬æ¢å›æ¥

```R
n=t(scale(t(dat[top_g,])))
```

#### ç”»ä¸ªæ–°çš„çƒ­å›¾

å¯ä»¥çœ‹åˆ°ä¹‹å‰çƒ­å›¾æ˜¾ç¤ºçš„åæ ‡èŒƒå›´æ˜¯0- 15ï¼Œå½“ç„¶è¿™é‡Œæˆ‘ä»¬å¯ä»¥è®¾ç½®ä¸Šé™ã€ä¸‹é™ï¼Œæ¯”å¦‚å¯ä»¥å°†ä¸Šé™è®¾ä¸º2ï¼Œä¸‹é™è®¾ä¸º-2

```R
n[n>2]=2
n[n< -2]= -2
```

èŒƒå›´è®¾ç½®å¥½ä»¥åï¼Œå¯ä»¥å†å°†åˆ†ç»„ä¿¡æ¯`grp`åŠ ä¸Šå»

```R
# å…ˆæ„å»ºä¸€ä¸ªåˆ†ç»„çš„æ•°æ®æ¡†ï¼Œåˆ—æ˜¯åŸæ¥çš„åˆ†ç»„ä¿¡æ¯
anno_col=data.frame(g=grp)
# è¡Œåæ˜¯æ ·æœ¬åï¼Œä¹Ÿå°±æ˜¯å½’ä¸€åŒ–åçš„nçŸ©é˜µçš„åˆ—å
rownames(anno_col)=colnames(n)
# çœ‹ä¸€ä¸‹ç»“æœ
> head(anno_col)
               g
SS2_15_0048_A3 1
SS2_15_0048_A6 1
SS2_15_0048_A5 2
SS2_15_0048_A4 3
SS2_15_0048_A1 2
SS2_15_0048_A2 3
```

æœ€åè®¾ç½®pheatmapçš„é€‰é¡¹ï¼š

```R
    pheatmap(n,
             show_colnames =F, #ä¸æ˜¾ç¤ºåˆ—å
             show_rownames = F, #ä¸æ˜¾ç¤ºè¡Œå
             annotation_col=anno_col, # åœ¨åˆ—ä¸ŠåŠ æ³¨é‡Š(ä¹Ÿå°±æ˜¯åˆ†ç»„ä¿¡æ¯)
             filename = 'all_cells_top_1000_new.png')
```

![](https://upload-images.jianshu.io/upload_images/9376801-686bd885b408e5f4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

å¯ä»¥çœ‹åˆ°è¿™å¼ å›¾å’Œç”»çš„ç¬¬ä¸€å¼ å›¾çš„åŒºåˆ«æ˜¯ï¼šå‡ºç°äº†ä¸€äº›çº¢è‰²ï¼Œè¯´æ˜æ–°å‡ºç°äº†ä¸€äº›åŸºå› åœ¨æŸäº›æ ·æœ¬ä¸­é«˜è¡¨è¾¾ï¼Œå¹¶ä¸”å¾ˆæ˜æ˜¾ã€‚ä½†æ˜¯ä»ç„¶å¾ˆæœ‰å¯èƒ½å®ƒä»¬çš„å®é™…è¡¨è¾¾é‡å¹¶ä¸é«˜ï¼Œä»…ä»…æ˜¯ç©äº†ä¸€ä¸ª"æ ·æœ¬æ’ä½èµ›â€œ(å³ä½¿æ•°å€¼å†å°ï¼Œä¹Ÿæœ‰ç”²ä¹™ä¸™ä¸)

#### å…³äºåˆ†ç»„æœ‰ä¸€ç‚¹å¥‡æ€ª

å¯ä»¥çœ‹åˆ°è¿™é‡Œçš„åˆ†ç»„ä¿¡æ¯æœ‰ç‚¹æ•£ä¹±ï¼Œæƒ³åˆ°ï¼šè¿™é‡Œä½¿ç”¨çš„`anno_col` æ˜¯åˆ©ç”¨`grp`å¾—åˆ°çš„ï¼Œè€Œ`grp`æ˜¯åŸºäºä¸€ä¸‡å¤šåŸºå› çš„`dat`çŸ©é˜µå¾—åˆ°çš„(å›å¿†ä¸‹ç¬¬5ç¯‡å†…å®¹)

![](https://upload-images.jianshu.io/upload_images/9376801-cd2b437ffcdebd23.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

å› æ­¤è¿™é‡Œçš„åˆ†ç»„ä¿¡æ¯å¯ä»¥æ›´æ–°ä¸€ä¸‹ï¼ŒåŸºäºæˆ‘ä»¬è¿™é‡Œçš„top1000åŸºå› ï¼Œåªéœ€è¦å°†åŸæ¥çš„`dat`æ¢æˆç°åœ¨çš„`n`çŸ©é˜µå°±å¥½ï¼Œä¾ç„¶é€‰å–å‰4ä¸ªèšç±»åˆ†ç¾¤

```R
# å°†åŸæ¥datæ¢ä¸ºn
hc=hclust(dist(t(n))) 
clus = cutree(hc, 4)
top1000_grp=as.factor(clus)
> table(top1000_grp)
top1000_grp
  1   2   3   4 
462 166  42  98 
```

çœ‹ä¸€ä¸‹**å½“å‰åŸºäº1000ä¸ªåŸºå› çš„å‰4ç»„å’ŒåŸæ¥åŸºäºæ‰€æœ‰åŸºå› çš„å‰4ç»„ä¹‹é—´é‡åˆåº¦**ï¼Œè™½ç„¶ä»–ä»¬æ€»å’Œä¸€æ ·ï¼Œéƒ½æ˜¯1000ï¼Œè€Œä¸”ä¹Ÿéƒ½æ˜¯æŒ‰ç…§1-4çš„é¡ºåºæ’åˆ—ï¼Œä½†å®é™…ä¸ŠèƒŒåçš„æ„ä¹‰åƒå·®ä¸‡åˆ«

```R
> table(top1000_grp,grp)
           grp
top1000_grp   1   2   3   4
          1 167 295   0   0
          2   7   3 121  35
          3  42   0   0   0
          4  96   2   0   0
```

ä¸¾ä¸ªä¾‹å­ï¼Œæœ‰462ä¸ªåŸºå› å±äºæ–°åˆ†ç»„çš„1å·ç»„ï¼Œä½†å…¶ä¸­æœ‰295ä¸ªå±äºåŸæ¥åˆ†ç»„çš„2å·ç»„(è¿™ä¸ªæ•°é‡è¶…è¿‡äº†åŸæ¥åˆ†ç»„çš„1å·ç»„)ï¼Œå¯ä»¥çœ‹å‡º**æ–°åˆ†ç»„å’ŒåŸåˆ†ç»„çš„é‡åˆåº¦å¹¶ä¸é«˜ï¼Œ**å› æ­¤æ›´åŠ è¯´æ˜æˆ‘ä»¬é‡æ–°åˆ†ç»„çš„é‡è¦æ€§

![](https://upload-images.jianshu.io/upload_images/9376801-811c7f24b312306f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

```R
new_anno_col=data.frame(g=top1000_grp)
rownames(new_anno_col)=colnames(n)
 pheatmap(n,
             show_colnames =F, #ä¸æ˜¾ç¤ºåˆ—å
             show_rownames = F, #ä¸æ˜¾ç¤ºè¡Œå
             annotation_col=new_anno_col, # åœ¨åˆ—ä¸ŠåŠ æ³¨é‡Š(ä¹Ÿå°±æ˜¯åˆ†ç»„ä¿¡æ¯)
             filename = 'all_cells_top_1000_new_2.png')
```

![](https://upload-images.jianshu.io/upload_images/9376801-b39afce698ff0f84.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)



### åšä¸ªPCA

ä¹‹å‰å¥½ä¸å®¹æ˜“è¿‡æ»¤å¾—åˆ°çš„`dat`çŸ©é˜µï¼Œä¸èƒ½å› ä¸ºä¸‹é¢åˆ†æçš„å¤±è¯¯è¢«"æ±¡æŸ“"ï¼Œå› æ­¤å†è¿›è¡Œä¸‹ä¸€ä¸ªåˆ†æä¹‹å‰å…ˆåšä¸€ä¸ªæ•°æ®å¤‡ä»½æ˜¯ä¸ªå¥½ä¹ æƒ¯

```R
dat_bk=dat
# ç„¶åæˆ‘ä»¬å°±èƒ½æ”¾å¿ƒå¯¹datè¿›è¡Œæ“ä½œäº†
dat=t(dat)
dat=as.data.frame(dat)
dat=cbind(dat,grp)
```

PCAåˆ†æéœ€è¦è¡Œæ˜¯æ ·æœ¬ï¼Œåˆ—æ˜¯åŸºå› è¡¨è¾¾é‡çš„æ•°æ®æ¡†(å’Œèšç±»ä¸€æ ·ï¼Œæ˜¯å¯¹è¡Œ/æ ·æœ¬è¿›è¡Œæ“ä½œï¼Œæœ€ååšçš„å›¾ä¸­ä¸€ä¸ªç‚¹å°±è¡¨ç¤ºä¸€ä¸ªæ ·æœ¬/ç»†èƒ)

![](https://upload-images.jianshu.io/upload_images/9376801-6773af10f056a102.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

æœ€åç”¨`PCA`è¿›è¡Œè®¡ç®—åˆ†æï¼Œç”¨`fviz_pca_ind`å‡½æ•°è¿›è¡Œå¯è§†åŒ–

è¿™é‡Œç”¨åˆ°çš„åˆ†ç»„è¿˜æ˜¯ä¹‹å‰åŸºäºå…¨éƒ¨åŸºå› è¿›è¡Œèšç±»çš„`cutree`ç»“æœ

```R
library("FactoMineR")
library("factoextra") 
dat.pca <- PCA(dat[,-ncol(dat)], graph = FALSE) #'-'è¡¨ç¤ºâ€œéâ€
fviz_pca_ind(dat.pca,repel =T,
               geom.ind = "point", 
               col.ind = dat$grp, # æŒ‰ç»„åˆ†é¢œè‰²
               # palette = c("#00AFBB", "#E7B800"),
               addEllipses = TRUE, 
               legend.title = "Groups"
  )
```

![](https://upload-images.jianshu.io/upload_images/9376801-da974bc45e78c6e0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)





















