# å•ç»†èƒè½¬å½•ç»„å­¦ä¹ ç¬”è®°-4

> åˆ˜å°æ³½å†™äº19.6.14-15
> ç¬”è®°ç›®çš„ï¼šæ ¹æ®ç”Ÿä¿¡æŠ€èƒ½æ ‘çš„å•ç»†èƒè½¬å½•ç»„è¯¾ç¨‹æ¢ç´¢smart-seq2æŠ€æœ¯ç›¸å…³çš„åˆ†ææŠ€æœ¯
> è¯¾ç¨‹é“¾æ¥åœ¨ï¼šhttp://jm.grazy.cn/index/mulitcourse/detail.html?cid=53
> ç¬¬äºŒå•å…ƒç¬¬äºŒã€ä¸‰è®²ï¼šè·å–Githubä»£ç åŒ…ä»¥åŠå‡†å¤‡å·¥ä½œ

### å…ˆä¸‹è½½ä»£ç åŒ…

githubä»£ç åœ¨ï¼šhttps://github.com/jmzeng1314/scRNA_smart_seq2/archive/master.zip

![](https://upload-images.jianshu.io/upload_images/9376801-473dec7be28987ff.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

é¦–å…ˆè¿›å…¥RNA-seqç›®å½•ï¼Œä»step0-step9æ˜¯å¯¹å¸¸è§„è½¬å½•ç»„çš„ä¸€ä¸ªå›é¡¾

### å‡†å¤‡å·¥ä½œä¹‹RåŒ…

> ä»step0å¼€å§‹ï¼Œä»£ç æ³¨é‡Šè›®è¯¦ç»†çš„ï¼Œæˆ‘ä¼šæŒ‘é€‰é‡è¦çš„éƒ¨åˆ†å†™åˆ°è¿™é‡Œï¼Œå…¶ä»–å¯ä»¥è‡ªè¡Œçœ‹ä»£ç å­¦ä¹ ï¼Œä¸‹é¢å°±æ˜¯ä¸»è¦åˆ©ç”¨Rstudioè¿›è¡Œæ“ä½œäº†

- ä¸€ä¸ªå¥½ä¹ æƒ¯ï¼Œåšæ–°é¡¹ç›®æ—¶è®°å¾—æ¸…ç©ºä¹‹å‰çš„å˜é‡ï¼Œä½¿ç”¨`rm(list = ls())` 

- æœ‰çš„RåŒ…æ¯”è¾ƒå¤§ï¼Œç»å¸¸éœ€è¦åŠ è½½å…¶ä»–çš„åŠ¨æ€åº“dynamically loaded libraries (DLLs)ï¼Œä¾‹å¦‚ï¼š

  ```R
  > length(loadedNamespaces()) 
  [1] 34
  > library(Seurat) #åŠ è½½ä¸€ä¸ªseuratåŒ…ä¼šå‡ºç°æ¥è¿‘60ä¸ªä¾èµ–çš„åŠ¨æ€åº“
  > length(loadedNamespaces())
  [1] 96
  ```

  å¦‚æœä¸è®¾ç½®ï¼Œå°±ä¼šå› ä¸º**åŠ è½½æ•°é‡è¶…é™åˆ¶è€ŒæŠ¥é”™**(https://developer.r-project.org/Blog/public/2018/03/23/maximum-number-of-dlls/)

  åœ¨R3.3ç‰ˆæœ¬ä¸­ï¼Œåªèƒ½æœ‰100ä¸ªå›ºå®šçš„åŠ¨æ€åº“é™åˆ¶ï¼Œåˆ°äº†3.4ç‰ˆæœ¬ä»¥åï¼Œå°±èƒ½å¤Ÿä½¿ç”¨`Sys.setenv(R_MAX_NUM_DLLS=xxx)`è¿›è¡Œè®¾ç½®ï¼Œè€Œè¿™ä¸ªæ•°å­—æ ¹æ®ä¸ªäººæƒ…å†µè®¾å®š

- åœ¨æ–°å»ºæ•°æ®æ¡†æ—¶ä¼šè‡ªåŠ¨å°†å­—ç¬¦ä¸²çš„åˆ—å½“åšæ˜¯å› å­å‹å‘é‡ï¼Œä½†æ˜¯æˆ‘ä»¬å¸¸å¸¸è¿˜éœ€è¦å¯¹å­—ç¬¦è¿›è¡Œä¿®æ”¹ï¼Œå› æ­¤éœ€è¦å…ˆå°†è¿™ä¸ªè®¾ç½®å–æ¶ˆï¼š`options(stringsAsFactors = F)` 

- å› ä¸ºBioconductorä¸‹è½½æ–¹æ³•çš„å˜åŠ¨ï¼Œè¦å­¦ä¼šä½¿ç”¨`BiocManager::install`è¿™ä¸ªå‘½ä»¤ï¼Œä¾‹å¦‚ï¼š`BiocManager::install(c( 'scran'),ask = F,update = F)`ï¼Œæ–°åŠ çš„ä¸¤ä¸ªé€‰é¡¹è¡¨ç¤ºï¼šä¸è¦é—®æˆ‘è¦ä¸è¦ä¸‹è½½ï¼Œç›´æ¥ä¸‹ï¼è¿˜æœ‰ä¸è¦é—®æˆ‘è¦ä¸è¦æ›´æ–°ï¼Œä¸æ›´æ–°ï¼ã€é™¤éä¸å‡çº§å°±æŠ¥é”™ã€‘

- ä¸‹è½½åŒ…å­˜åœ¨ç½‘ç»œçš„é™åˆ¶ï¼Œæ¯•ç«ŸRè¯­è¨€æ˜¯å›½å¤–å¼€å‘ï¼Œå› æ­¤å¯ä»¥é€šè¿‡`options()$repos`çœ‹çœ‹å¸¸è§„CRANå®‰è£…RåŒ…çš„ä½¿ç”¨é•œåƒ(ä¸€èˆ¬æƒ…å†µä¸‹æ˜¯rstudioå…¬å¸çš„)ï¼Œä½†æ˜¯è¿™é‡Œæˆ‘ä»¬å¯ä»¥è‡ªè¡Œè®¾ç½®ï¼šæ¯”å¦‚è®¾ç½®æˆæ¸…åæºï¼š`options("repos" = c(CRAN="https://mirrors.tuna.tsinghua.edu.cn/CRAN/"))`ï¼Œå¦å¤–Bioconductorä¹Ÿæœ‰è‡ªå·±çš„é•œåƒè®¾ç½®ï¼šä¿®æ”¹ä¸€ä¸‹`options`å³å¯ï¼Œ`options(BioC_mirror="https://mirrors.ustc.edu.cn/bioc/") ` 

  ```R
  # æ€»ç»“ä¸€ä¸‹ï¼Œå¯ä»¥å…ˆç”¨ifåˆ¤æ–­å†è¿›è¡Œè®¾ç½®
  if(length(getOption("CRAN"))==0) options(CRAN="https://mirrors.tuna.tsinghua.edu.cn/CRAN/")
  
  if(!require("BiocManager")) install.packages("BiocManager",update = F,ask = F)
  
  if(length(getOption("BioC_mirror"))==0) options(BioC_mirror="https://mirrors.ustc.edu.cn/bioc/")
  ```

- å¦‚ä½•ä½¿ç”¨**ifåˆ¤æ–­è¯­å¥è¿›è¡ŒåŒ…çš„å®‰è£…**ï¼š

  ```R
  if (!requireNamespace("BiocManager", quietly = TRUE)) 
    install.packages("BiocManager") 
  ```

æœ€åï¼Œå°±æ˜¯å®‰è£…æ‰€æœ‰å¿…å¤‡çš„RåŒ…(åŒ…æ‹¬CRANå’ŒBioconductor)

```R
# å¿«é€Ÿå®‰è£…cranåŒ…
cran_pkgs <- c("ggfortify","FactoMineR","factoextra")
for (pkg in cran_pkgs){
  if (! require(pkg,character.only=T) ) {
    install.packages(pkg,ask = F,update = F)
    require(pkg,character.only=T) 
    }
}
# BioconductoråŒ…
library(BiocManager)
bioc_pkgs <- c("scran","TxDb.Mmusculus.UCSC.mm10.knownGene","org.Mm.eg.db","genefu","org.Hs.eg.db","TxDb.Hsapiens.UCSC.hg38.knownGene")
for (pkg in bioc_pkgs){
  if (! require(pkg,character.only=T) ) {
    BiocManager::install(pkg,ask = F,update = F)
    require(pkg,character.only=T) 
    }
 }
```

ç›®çš„ï¼šåˆ©ç”¨RåŒ…é‡å¤æ–‡ç« çš„åŸºå› æ•°é‡å›¾ã€èšç±»å›¾ã€åŸºå› åœ¨èšç±»å›¾ä¸­çš„çƒ­å›¾ã€æ¯ä¸ªåŸºå› è¡¨è¾¾é‡åœ¨ä¸åŒclusterçš„å°æç´å›¾

### å‡†å¤‡å·¥ä½œä¹‹è¡¨è¾¾çŸ©é˜µ

![](https://upload-images.jianshu.io/upload_images/9376801-72aac7eabb0247bc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

çœ‹åˆ°æ–‡ç« ä¸­æœ‰ä¸¤ä¸ªè¡¨è¾¾çŸ©é˜µï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªæ˜¯åŸå§‹è¡¨è¾¾çŸ©é˜µ(å‡ä¸ºæ•´æ•°ï¼‰ï¼Œç¬¬äºŒä¸ªæ˜¯rpkmæ˜¯è¡¨è¾¾é‡å½’ä¸€åŒ–åçš„å€¼(åŒ…å«äº†å°æ•°)ï¼Œå› æ­¤ä¹Ÿèƒ½è¯´æ˜ä¸ºä½•ç¬¬äºŒä¸ªæ–‡ä»¶æ¯”ç¬¬ä¸€ä¸ªè¦å¤§ã€‚

> **RPKM**è¿™ä¸ªæŒ‡æ ‡å¯ä»¥è¿™æ ·ç†è§£ï¼šRè¡¨ç¤ºreadsï¼ŒKè¡¨ç¤ºåŸºå› é•¿åº¦ï¼ŒMè¡¨ç¤ºæ–‡åº“å¤§å°ï¼Œå®ƒå®é™…ä¸Šåšçš„äº‹æƒ…ä¹Ÿå°±æ˜¯å»æ‰åŸºå› é•¿åº¦å’Œæµ‹åºæ–‡åº“çš„å·®å¼‚å¯¹readsæ¯”å¯¹æ•°é‡çš„å½±å“

å¥½ï¼Œå…ˆè¯´è¯´**ä¸ºä»€ä¹ˆè¦å»æ‰æ–‡åº“å¤§å°å·®å¼‚**ï¼šä»¥è¿™ç¯‡æ–‡ç« ä¸­çš„å›¾ç‰‡ä¸ºä¾‹ï¼šhttps://sci-hub.tw/https://doi.org/10.1186/s13059-018-1466-5

![](https://upload-images.jianshu.io/upload_images/9376801-b1b60a1eeb671164.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

æ¯”å¦‚æœ‰ä¸¤ä¸ªæ ·æœ¬ï¼Œè¦æ¯”è¾ƒä¸‰ä¸ªåŸºå› ABCçš„è¡¨è¾¾é‡ï¼Œå›¾ä¸­è¶Šé«˜è¡¨ç¤ºæ¯”å¯¹åˆ°è¿™ä¸ªåŸºå› çš„readsæ•°è¶Šå¤šï¼Œå› æ­¤åœ¨åŒä¸€ä¸ªæ ·æœ¬ä¸­å¯ä»¥çœ‹åˆ°C>B>Aï¼Œä½†æ˜¯ä¸åŒçš„ä¸¤ä¸ªæ ·æœ¬å‘¢ï¼Ÿ

> æµ‹åºé‡ä¸åŒï¼Œæ¯”å¤§å°æ˜¯ä¸å…¬å¹³çš„

ä¸¾ä¸ªå¤¸å¼ çš„ä¾‹å­ï¼šä¸Šé¢ğŸ‘†çš„æ ·æœ¬ï¼ˆç®€ç§°"æ ·æœ¬1"ï¼‰ä¸­ä¸€å…±æ¯”å¯¹äº†100ä¸‡æ¡readsï¼Œå…¶ä¸­CåŸºå› æ¯”å¯¹åˆ°äº†100æ¡ï¼›ä¸‹é¢ğŸ‘‡çš„æ ·æœ¬ï¼ˆç®€ç§°"æ ·æœ¬2"ï¼‰ä¸­ä¸€å…±æ¯”å¯¹äº†100æ¡readsï¼Œå…¶ä¸­CåŸºå› æ¯”å¯¹äº†10æ¡ã€‚è™½ç„¶æœ€ç»ˆçš„æ•°æ®æ˜¾ç¤ºï¼šæ ·æœ¬1ä¸­CåŸºå› æ¯”æ ·æœ¬2çš„CåŸºå› æ¯”å¯¹readsæ•°å¤šäº†90æ¡ï¼Œä½†æ˜¯è€ƒè™‘åˆ°å®é™…æ ·æœ¬æƒ…å†µå°±æ˜¯ï¼Œæ ·æœ¬2ä¸­CåŸºå› å¯æ˜¯å æ®äº†æ€»æ¯”å¯¹é‡çš„ååˆ†ä¹‹ä¸€ï¼Œè€Œæ ·æœ¬1å‘¢ï¼Ÿå¾ˆå°å¾ˆå°â€¦ã€‚å› æ­¤å»æ‰M(ä¹Ÿå°±æ˜¯æ¯ä¸ªæ ·æœ¬çš„æµ‹åºæ–‡åº“å¤§å°ï¼Œä»¥Millionä¸ºå•ä½)çš„å½±å“ï¼Œæ‰æ˜¯æ¯”è¾ƒå®¢è§‚çš„ã€‚

åŒæ ·çš„ï¼Œæœ‰çš„åŸºå› é•¿ï¼Œæœ‰çš„åŸºå› çŸ­ï¼Œå¼€å‘RPKMçš„äººå°±æƒ³ï¼šåŸºå› é•¿çš„æ¯”å¯¹åˆ°çš„readsä¹Ÿä¼šæ›´å¤šï¼Œå› æ­¤ä¹Ÿå»æ‰äº†è¿™ä¸ªå·®å¼‚(é™¤ä»¥K)

> ä½†æ˜¯ï¼è¿™ä¸ªæ¦‚å¿µç›®å‰åœ¨ç»Ÿè®¡ä¸Šæ˜¯é”™è¯¯çš„ï¼Œå› æ­¤å¹¶ä¸å»ºè®®ä½¿ç”¨è¿™ä¸ªæŒ‡æ ‡

### æ“ä½œè¡¨è¾¾çŸ©é˜µ

#### è¯»å–

```R
# ä¿ç•™å¤´ä¿¡æ¯ï¼Œå¹¶è®¾ç½®åˆ†éš”ç¬¦ä¸ºåˆ¶è¡¨ç¬¦tab
a=read.table('../GSE111229_Mammary_Tumor_fibroblasts_768samples_rawCounts.txt.gz',header = T ,sep = '\t')

# è¯»è¿›æ¥ä»¥åï¼Œç®€å•æŸ¥çœ‹ä¸€ä¸‹
a[1:6,1:4]
```

#### è¿‡æ»¤

å¯ä»¥çœ‹åˆ°å¾ˆå¤šåŸºå› å¯¹åº”çš„è¡¨è¾¾é‡éƒ½æ˜¯0

![](https://upload-images.jianshu.io/upload_images/9376801-5e993e2d5a05f71d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

ä¸‹é¢ä¼šç”¨åˆ°å¾ªç¯ï¼Œä½†æ˜¯ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œ**å…ˆæ‹¿å…¶ä¸­ä¸€è¡Œä¸ºä¾‹ï¼š**

```R
x=a[1,] #æ¯”å¦‚å°†ç¬¬ä¸€è¡Œæå–å‡ºæ¥èµ‹å€¼ç»™x
# å°†xä¸­çš„å€¼ä¸1ä½œæ¯”è¾ƒ(åˆ©ç”¨äº†Rè¯­è¨€çš„å¾ªç¯è¡¥é½ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒä¼šå°†768ä¸ªå€¼ä¸€ä¸ªä¸€ä¸ªå»å’Œ1åšæ¯”è¾ƒï¼Œç„¶åè¿”å›é€»è¾‘å€¼TRUEæˆ–è€…FALSE)
x>1
# ç„¶ååˆ©ç”¨table()å‡½æ•°æ£€æŸ¥xä¸­æœ‰å¤šå°‘æ˜¯TRUEï¼Œå¤šå°‘æ˜¯FALSE
table(x>1)
# FALSE  TRUE 
#   766     2 
# å¯ä»¥çœ‹åˆ°ç¬¬ä¸€è¡Œè¿™ä¸ªåŸºå› åœ¨768ä¸ªç»†èƒä¸­åªæœ‰ä¸¤ä¸ªç»†èƒæœ‰è¡¨è¾¾ï¼Œæˆ‘ä»¬è®¤ä¸ºï¼šè¿™ä¸¤ä¸ªç»†èƒä¹Ÿä¸å¥½åˆ†ç»„ï¼Œclusterèšç±»ä¹Ÿæ²¡æœ‰ä»€ä¹ˆæ„ä¹‰ï¼Œå› æ­¤å¯ä»¥å»æ‰
# ä½†æ˜¯è¿™ä¸ªç»†èƒé‡è®¾ç½®æˆå¤šå°‘åˆé€‚å‘¢ï¼Ÿæ€»ä¸èƒ½ä¸èƒ½ä¸€è‚¡è„‘å…¨è®¾æˆ2å§
floor(ncol(a)/50) # ç”¨æ€»åˆ—æ•°é™¤ä»¥50ç„¶åå‘ä¸‹å–æ•´ï¼Œç»“æœå°±æ˜¯15
# ä¹Ÿå°±æ˜¯è¯´ï¼Œåªè¦ä¸€è¡Œä¸­è‡³å°‘è¦åœ¨15ä¸ªæ ·æœ¬ä¸­æœ‰è¡¨è¾¾é‡
# ä¸Šé¢çŸ¥é“äº† x>1 è¿”å›é€»è¾‘å€¼0å’Œ1ï¼Œ0ä¸ºFALSEï¼Œ1ä¸ºTRUEã€‚ç°åœ¨æˆ‘ä»¬è¦æ‰¾ä¸€è¡Œä¸­æ€»å…±æœ‰å¤šå°‘TRUEï¼Œå°±ç”¨sumè®¡ç®—ä¸€ä¸‹(å› ä¸ºä¼šå¿½ç•¥æ‰0çš„å½±å“)
sum(x>1) > floor(ncol(a)/50)
# å½“ç„¶ç¬¬ä¸€è¡Œä¼šè¿”å›FALSEï¼Œä¹Ÿå°±è¡¨æ˜æˆ‘ä»¬è¦å»æ‰è¿™ä¸€è¡Œå†…å®¹
a[sum(x>1) > floor(ncol(a)/50),]# å°±æŠŠä¸ç¬¦åˆè¦æ±‚çš„ç¬¬ä¸€è¡Œå»æ‰äº†
```

ä¸Šé¢ï¼Œæˆ‘ä»¬å¯¹ä¸€è¡Œçš„ç­›é€‰ä¸è¿‡æ»¤æœ‰äº†è®¤è¯†ï¼Œé‚£ä¹ˆä¸€ä¸ªè¡¨è¾¾çŸ©é˜µæœ‰2ä¸‡å¤šè¡Œï¼Œ**æ€æ ·å®ç°å¾ªç¯æ“ä½œå‘¢ï¼Ÿ**

```R
# ä¸“ä¸šçš„äº‹æƒ…äº¤ç»™ä¸“ä¸šçš„å·¥å…·å»å¤„ç†=ã€‹apply
# è¦ä½¿ç”¨applyå‡½æ•°å…ˆè¦æ˜ç™½ä¸‰ä¸ªé—®é¢˜ï¼šå¯¹è°è¿›è¡Œæ“ä½œï¼Ÿå¯¹è¡Œè¿˜æ˜¯åˆ—è¿›è¡Œæ“ä½œï¼Ÿæ“ä½œä»€ä¹ˆï¼Ÿ
apply(a, 1, function(x) {sum(x>1) > floor(ncol(a)/50)})
# 1ï¼šå¯¹aè¿™ä¸ªçŸ©é˜µè¿›è¡Œæ“ä½œ
# 2ï¼šå¯¹è¡Œ(ä¹Ÿå°±æ˜¯1è¡¨ç¤º)è¿›è¡Œæ“ä½œ[è¡¥å……ï¼šå¦‚æœå¯¹åˆ—æ“ä½œï¼Œç”¨2è¡¨ç¤º]
# 3ï¼šæ“ä½œä»€ä¹ˆï¼Ÿå¤æ‚çš„æ“ä½œå…ˆå†™ä¸Š function(x){}ï¼Œè¿™æ˜¯ä¸€ä¸ªæ ‡å‡†æ ¼å¼ï¼Œç„¶åå¤§æ‹¬å·ä¸­æ˜¯è¦è¿›è¡Œæ“ä½œçš„å‡½æ•°ï¼Œäºæ˜¯æˆ‘ä»¬å°±å¯ä»¥å°†æˆ‘ä»¬ä¹‹å‰å†™çš„é‚£ä¸€è¡Œç²˜åˆ°è¿™é‡Œï¼Œæœ€åä»ç„¶æ˜¯é€»è¾‘å€¼
```

æœ€åï¼Œæœ‰å¤šå°‘è¡Œå°±ä¼šè¿”å›å¤šå°‘ä¸ªapplyåˆ¤æ–­çš„é€»è¾‘å€¼ï¼Œæ˜¾ç¤ºFALSEçš„å°±æ˜¯è¦è¿‡æ»¤æ‰çš„ï¼Œäºæ˜¯å†ç”¨è¡Œç­›é€‰å®Œæˆæ•´ä¸ªæ“ä½œï¼Œå¹¶èµ‹å€¼ç»™ä¸€ä¸ªæ–°å˜é‡ï¼š

```R
dat=a[apply(a,1, function(x) sum(x>1) > floor(ncol(a)/50)),] 
dim(dat)
# 12198   768 æœ€ç»ˆå°±ä¿ç•™äº†12198ä¸ªåŸºå› 
```

> å…¶å®åŸæ–‡ä¿ç•™çš„æ›´å°‘ï¼ŒåŸæ–‡åªæœ‰10835ä¸ªåŸºå› 









